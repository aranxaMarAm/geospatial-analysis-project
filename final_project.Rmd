---
title: "Geospatial Final Project"
author: "Aranxa Márquez Ampudia & Milton Mier Santander"
date: "2025-05-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Packages to be used

```{r}
# Load Packages

library(sf) |> suppressMessages() # for spatial vector data
library(dplyr) |> suppressMessages()
library(tidyr)
library(stringr)
library (terra) # for spatial data analysis with vector and raster data
library(tmap) # for static and interactive maps
library(spdep) # for spatial dependency (session 6)
library(leaflet) # for interactive maps
library(units) |> suppressMessages() # for measurement units in R vectors, matrices and arrays automatic propagation, conversion, derivation and simplification of units
library(giscoR)
library(arrow)
library(jsonlite)
library(geojsonsf)
library(geojsonio)
library(spatialreg)
library(gridExtra)
library(patchwork)


if (!require("tidycensus", quietly = TRUE)) install.packages("tidycensus") 

```


## Load indicators data 

```{r}
# Load data

zip_filename <- "final_df.zip"
csv_filename <- "../final_df.csv"

# Temporary directory
temp_dir <- tempdir()

# Extract the specific CSV file to temp dir
unzip(zipfile = zip_filename, files = csv_filename, exdir = temp_dir)

# Extracted file will retain directory structure, verify exact path:
extracted_file_path <- file.path(temp_dir, csv_filename)

# Normalize path (since "../" could cause issues)
extracted_file_path <- normalizePath(extracted_file_path, mustWork = FALSE)

# Check if extraction succeeded:
if (!file.exists(extracted_file_path)) {
    stop("Extraction failed. Check filenames and paths.")
}
```

```{r}
# Read the CSV into a dataframe
final_df <- read.csv(extracted_file_path)

# Clean up by deleting the file
file.remove(extracted_file_path)
```

```{r}
head(final_df)
```

## Load geospatial data 

```{r}
# Read GeoJSON
muni_sf <- geojson_sf("colombia_municipios_poblacion.json")
```

```{r}
head(muni_sf)
```


```{r}
## Assigning manually the Coordinate Reference System (CRS)
st_crs(muni_sf) <- 4326
```

```{r}
# Check number of geometries in original shapefile
nrow(muni_sf)

# Check number of records in final_df
nrow(final_df)

# Check join key overlap
length(intersect(muni_sf$MPIO_CDPMP, final_df$codmpio))
```

```{r}
# Convert both codes to character to ensure matching works
final_df <- final_df %>%
  mutate(codmpio = as.character(codmpio))

muni_sf <- muni_sf %>%
  mutate(MPIO_CCDGO = as.character(MPIO_CDPMP))
```


```{r}
final_22 <- final_df %>%
  filter(year == 2022)
```

```{r}
muni_sf <- muni_sf %>%
  mutate(MPIO_CCDGO = str_pad(as.character(MPIO_CDPMP), width = 5, pad = "0"))

final_22 <- final_22 %>%
  mutate(codmpio = str_pad(as.character(codmpio), width = 5, pad = "0"))
```

```{r}
joined_sf <- left_join(muni_sf, final_22, by = c("MPIO_CDPMP" = "codmpio"))
```


```{r}
# Moran's I test result for armed conclict 
moran.test(joined_clean$iica, lw, zero.policy = TRUE)
```


```{r}
sf::sf_use_s2(FALSE)

# Filter rows without NAs (just in case)
joined_clean <- joined_sf %>%
  filter(!is.na(iica))  

# Create neighbors and weights
nb <- poly2nb(joined_clean)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)

# Standardize the variable
iica_std <- scale(joined_clean$iica)

# Create lagged values
lag_iica <- lag.listw(lw, iica_std)

# Plot Moran scatter
plot(iica_std, lag_iica,
     xlab = "iica (standardized)",
     ylab = "Spatial lag of iica",
     main = "Moran Scatter Plot for iica")
abline(h = 0, v = 0, col = "gray")
abline(lm(lag_iica ~ iica_std), col = "red")

```

The results show that armed conflict presence doesn't occur spatially random, but it clusters geograph


```{r}
# Run Local Moran's I
local_iica <- localmoran(joined_clean$iica, lw, zero.policy = TRUE)

# Add cluster type to spatial data
joined_clean$Ii <- local_iica[,1]               # local Moran's I
joined_clean$p_Ii <- local_iica[,5]             # p-value

# Quadrant for cluster type
mean_iica <- mean(joined_clean$iica, na.rm = TRUE)
mean_lag <- mean(lag.listw(lw, joined_clean$iica), na.rm = TRUE)

joined_clean$quadrant <- NA
joined_clean$quadrant[
  joined_clean$iica >= mean_iica & lag.listw(lw, joined_clean$iica) >= mean_lag
] <- "High-High"
joined_clean$quadrant[
  joined_clean$iica <= mean_iica & lag.listw(lw, joined_clean$iica) <= mean_lag
] <- "Low-Low"
joined_clean$quadrant[
  joined_clean$iica >= mean_iica & lag.listw(lw, joined_clean$iica) <= mean_lag
] <- "High-Low"
joined_clean$quadrant[
  joined_clean$iica <= mean_iica & lag.listw(lw, joined_clean$iica) >= mean_lag
] <- "Low-High"

# Only keep significant values
joined_clean$quadrant[joined_clean$p_Ii > 0.05] <- NA

```

```{r}
# Moran's I test result
moran.test(joined_clean$H_coca, lw, zero.policy = TRUE)
```

Only significant LISA clusters (p < 0.05) are shown. Some quadrants (e.g., Low-Low or High-Low) do not appear due to lack of statistically significant spatial clustering.

```{r}
library(ggplot2)

ggplot(joined_clean) +
  geom_sf(aes(fill = quadrant), color = NA) +
  scale_fill_manual(
    values = c("High-High" = "red", "Low-Low" = "blue",
               "High-Low" = "orange", "Low-High" = "lightblue"),
  ) +
  labs(
    title = "LISA Cluster Map for iica (2022)",
    fill = "Cluster Type"
  ) +
  theme_minimal()

```



```{r}
# Filter out missing data
joined_clean_coca <- joined_sf %>%
  filter(!is.na(H_coca))

# Create neighbors and weights
nb_coca <- poly2nb(joined_clean_coca)
lw_coca <- nb2listw(nb_coca, style = "W", zero.policy = TRUE)

# Standardize the variable
coca_std <- scale(joined_clean_coca$H_coca)

# Create lagged values
lag_coca <- lag.listw(lw_coca, coca_std)  ## checar para después

# Plot Moran scatter
plot(coca_std, lag_coca,
     xlab = "H_coca (standardized)",
     ylab = "Spatial lag of H_coca",
     main = "Moran Scatter Plot for H_coca")
abline(h = 0, v = 0, col = "gray")
abline(lm(lag_coca ~ coca_std), col = "red")

```


```{r}
local_coca <- localmoran(joined_clean_coca$H_coca, lw_coca, zero.policy = TRUE)

# Store results
joined_clean_coca$Ii <- local_coca[,1]
joined_clean_coca$p_Ii <- local_coca[,5]
```


```{r}
mean_coca <- mean(joined_clean_coca$H_coca, na.rm = TRUE)
mean_lag_coca <- mean(lag.listw(lw_coca, joined_clean_coca$H_coca), na.rm = TRUE)

joined_clean_coca$quadrant <- NA
joined_clean_coca$quadrant[
  joined_clean_coca$H_coca >= mean_coca & lag.listw(lw_coca, joined_clean_coca$H_coca) >= mean_lag_coca
] <- "High-High"
joined_clean_coca$quadrant[
  joined_clean_coca$H_coca <= mean_coca & lag.listw(lw_coca, joined_clean_coca$H_coca) <= mean_lag_coca
] <- "Low-Low"
joined_clean_coca$quadrant[
  joined_clean_coca$H_coca >= mean_coca & lag.listw(lw_coca, joined_clean_coca$H_coca) <= mean_lag_coca
] <- "High-Low"
joined_clean_coca$quadrant[
  joined_clean_coca$H_coca <= mean_coca & lag.listw(lw_coca, joined_clean_coca$H_coca) >= mean_lag_coca
] <- "Low-High"

# Only show significant clusters
joined_clean_coca$quadrant[joined_clean_coca$p_Ii > 0.05] <- NA

```


```{r}
library(ggplot2)

ggplot(joined_clean_coca) +
  geom_sf(aes(fill = quadrant), color = NA) +
  scale_fill_manual(
    values = c(
      "High-High" = "red",
      "Low-Low" = "blue",
      "High-Low" = "orange",
      "Low-High" = "lightblue"
    )
  ) +
  labs(
    title = "LISA Cluster Map for H_coca (2022)",
    fill = "Cluster Type"
  ) +
  theme_minimal()
```


```{r}

compute_lisa_clusters <- function(df, var, lw) {
  local <- localmoran(df[[var]], lw, zero.policy = TRUE)
  df$Ii <- local[, 1]
  df$pval <- local[, 5]

  mean_val <- mean(df[[var]], na.rm = TRUE)
  lag_val <- lag.listw(lw, df[[var]])

  df$cluster <- NA
  df$cluster[df[[var]] >= mean_val & lag_val >= mean(lag_val)] <- "High-High"
  df$cluster[df[[var]] <= mean_val & lag_val <= mean(lag_val)] <- "Low-Low"
  df$cluster[df[[var]] >= mean_val & lag_val <= mean(lag_val)] <- "High-Low"
  df$cluster[df[[var]] <= mean_val & lag_val >= mean(lag_val)] <- "Low-High"
  df$cluster[df$pval > 0.05] <- NA  # Remove non-significant

  return(df)
}
```


```{r}
compute_lisa_clusters <- function(df, var, lw) {
  local <- localmoran(df[[var]], lw, zero.policy = TRUE)
  df$Ii <- local[, 1]
  df$pval <- local[, 5]
  
  # Compute variable and lag means
  df$var_std <- df[[var]]
  df$lag_var <- lag.listw(lw, df$var_std)

  mean_var <- mean(df$var_std, na.rm = TRUE)
  mean_lag <- mean(df$lag_var, na.rm = TRUE)

  df$cluster <- NA
  df$cluster[df$var_std >= mean_var & df$lag_var >= mean_lag] <- "High-High"
  df$cluster[df$var_std <= mean_var & df$lag_var <= mean_lag] <- "Low-Low"
  df$cluster[df$var_std >= mean_var & df$lag_var <= mean_lag] <- "High-Low"
  df$cluster[df$var_std <= mean_var & df$lag_var >= mean_lag] <- "Low-High"
  
  # Drop non-significant clusters
  df$cluster[df$pval > 0.05] <- NA
  
  return(df)
}
```


```{r}
# Apply to both
iica_lisa <- compute_lisa_clusters(joined_clean, "iica", lw)
coca_lisa <- compute_lisa_clusters(joined_clean_coca, "H_coca", lw_coca)
```


```{r}
table(joined_clean$cluster, useNA = "ifany")
```


```{r}
table(joined_clean_coca$cluster, useNA = "ifany")
```

```{r}
# Define color palette
lisa_colors <- c(
  "High-High" = "#B2182B",   # dark red
  "Low-Low"   = "#2166AC",   # dark blue
  "High-Low"  = "#762A83",   # purple
  "Low-High"  = "#1B9E77"    # teal
)

p1 <- ggplot(iica_lisa) +
  geom_sf(aes(fill = cluster), color = "white", size = 0.05) +
  scale_fill_manual(values = lisa_colors, na.value = "grey90") +
  labs(title = "LISA Clusters: iica (Conflict Intensity)", fill = "Cluster Type") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

p2 <- ggplot(coca_lisa) +
  geom_sf(aes(fill = cluster), color = "white", size = 0.05) +
  scale_fill_manual(values = lisa_colors, na.value = "grey90") +
  labs(title = "LISA Clusters: H_coca (Coca Cultivation)", fill = "Cluster Type") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

# Display side-by-side
grid.arrange(p1, p2, ncol = 2)
```

```{r}
# If it's GeoJSON:
dept_sf <- st_read("colombia_departamentos_poblacion.json")
```

```{r}
p1 <- p1 + 
  geom_sf(data = dept_sf, fill = NA, color = "black", size = 0.2)

p2 <- p2 + 
  geom_sf(data = dept_sf, fill = NA, color = "black", size = 0.2)
```



```{r}
# Disable s2 geometry to avoid issues with poly2nb
sf::sf_use_s2(FALSE)

# Read department-level boundaries
dept_sf <- st_read("colombia_departamentos_poblacion.json")

# Define color palette
lisa_colors <- c(
  "High-High" = "#d73027",   # red
  "Low-Low"   = "#4575b4",   # blue
  "High-Low"  = "#984ea3",   # purple
  "Low-High"  = "#1b9e77"    # teal
)

# Function to compute LISA clusters
compute_lisa_clusters <- function(df, var, lw) {
  local <- localmoran(df[[var]], lw, zero.policy = TRUE)
  df$Ii <- local[, 1]
  df$pval <- local[, 5]

  mean_val <- mean(df[[var]], na.rm = TRUE)
  lag_val <- lag.listw(lw, df[[var]])

  df$cluster <- NA
  df$cluster[df[[var]] >= mean_val & lag_val >= mean(lag_val)] <- "High-High"
  df$cluster[df[[var]] <= mean_val & lag_val <= mean(lag_val)] <- "Low-Low"
  df$cluster[df[[var]] >= mean_val & lag_val <= mean(lag_val)] <- "High-Low"
  df$cluster[df[[var]] <= mean_val & lag_val >= mean(lag_val)] <- "Low-High"
  df$cluster[df$pval > 0.05] <- NA

  return(df)
}

# Prepare LISA inputs
joined_iica <- joined_sf %>% filter(!is.na(iica))
joined_coca <- joined_sf %>% filter(!is.na(H_coca))

nb_iica <- poly2nb(joined_iica)
lw_iica <- nb2listw(nb_iica, style = "W", zero.policy = TRUE)

nb_coca <- poly2nb(joined_coca)
lw_coca <- nb2listw(nb_coca, style = "W", zero.policy = TRUE)

# Compute clusters
iica_lisa <- compute_lisa_clusters(joined_iica, "iica", lw_iica)
coca_lisa <- compute_lisa_clusters(joined_coca, "H_coca", lw_coca)

# Create plots
p1 <- ggplot(iica_lisa) +
  geom_sf(aes(fill = cluster), color = "white", size = 0.05) +
  geom_sf(data = dept_sf, fill = NA, color = "black", size = 0.2) +
  scale_fill_manual(values = lisa_colors, na.value = "grey90") +
  labs(title = "LISA Clusters: iica (Conflict Intensity)", fill = "Cluster Type") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

p2 <- ggplot(coca_lisa) +
  geom_sf(aes(fill = cluster), color = "white", size = 0.05) +
  geom_sf(data = dept_sf, fill = NA, color = "black", size = 0.2) +
  scale_fill_manual(values = lisa_colors, na.value = "grey90") +
  labs(title = "LISA Clusters: H_coca (Coca Cultivation)", fill = "Cluster Type") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

# Combine plots with patchwork
(p1 + p2) + 
  plot_layout(ncol = 2) +
  plot_annotation(
    title = "Spatial Clusters of Conflict and Coca Cultivation in Colombia",
    theme = theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
  )
```



