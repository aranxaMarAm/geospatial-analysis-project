---
title: "Untitled"
output: html_document
date: "2025-05-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Install packages for reading data and data manipulation
if (!require("dplyr", quietly = TRUE)|>suppressMessages()) install.packages("dplyr") #|> suppressMessages() prevents displaying unnecessary messages when loading the package.
if (!require("readr", quietly = TRUE)) install.packages("readr")

### Install packages for spatial data analysis
if (!require("sf", quietly = TRUE)) install.packages("sf") #sf= Single Features
if (!require("terra", quietly = TRUE)) install.packages("terra") #terra= Raster and Vector Spatial Data
if (!require("tmap")) install.packages("tmap") #tmap= Thematic Cartografy and visualization
if (!require("tmap", quietly = TRUE)) remotes::install_github('r-tmap/tmap') #ensures the latest development version is installed: If tmap is still missing after checking, it installs it from GitHub instead of CRAN.
if (!require("spDataLarge", quietly = TRUE)) install.packages("spDataLarge", repos = "https://nowosad.github.io/drat/", type = "source") #spDataLarge= contains large spatial datasets.
if (!require("gisCOR", quietly = TRUE))
if (!require("units", quietly = TRUE))

### Install other packages 
if (!require("remotes", quietly = TRUE)) install.packages("remotes") #remotes= GitHub Package Installer
if (!require("httr", quietly = TRUE)) install.packages("httr") #httr= http requests
if (!require("knitr", quietly = TRUE)) install.packages("knitr")

install.packages("jsonlite") 
install.packages(c("geojsonio", "ggplot2", "sf"))
library(geojsonio)
library(sf)
library(ggplot2)

```

```{r load packages, include=FALSE}
library(sf) |> suppressMessages()
library(dplyr) |> suppressMessages()
library(readr)
library(units) |> suppressMessages()
library(giscoR)
library(tmap)
library(ggplot2)
library(osmdata)
tmap_mode("view")
library("mapview")
library (terra)
library(jsonlite)
```

Load and visualize data

```{r}
# Check and set working directory
getwd()
setwd("C:/Users/mmier/OneDrive - Hertie School/3. Estudio/2025 MDS/2025-1 Geospatial Analysis/geospatial-analysis-project")


```
```{r}

zip_filename <- "final_df.zip"
csv_filename <- "../final_df.csv"

# Temporary directory
temp_dir <- tempdir()

# Extract the specific CSV file to temp dir
unzip(zipfile = zip_filename, files = csv_filename, exdir = temp_dir)

# Extracted file will retain directory structure, verify exact path:
extracted_file_path <- file.path(temp_dir, csv_filename)

# Normalize path (since "../" could cause issues)
extracted_file_path <- normalizePath(extracted_file_path, mustWork = FALSE)

# Check if extraction succeeded:
if (!file.exists(extracted_file_path)) {
    stop("Extraction failed. Check filenames and paths.")
}

# Read the CSV into a dataframe
final_df <- read.csv(extracted_file_path)

# Clean up by deleting the file
file.remove(extracted_file_path)





mun_sf <- geojson_sf("Colombia_departamentos_municipios_poblacion-topov2.json")

# Preview first few rows or elements
head(mun_sf)


ggplot(mun_sf) +
  geom_sf(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(title = "Municipalities")





final_df <- final_df %>%
  mutate(codmpio = as.character(codmpio))

# Assuming common key is "municipality_id"
mun_sf_merged <- mun_sf %>%
  left_join(final_df, by = c("MPIO_CCDGO" = "codmpio"))
head(mun_sf_merged)

```



PROMEDIO POR AÃ‘O

```{r}

final_df_avg <- final_df %>%
  group_by(codmpio) %>%
  summarise(gdp_pc = mean(gdp_pc, na.rm = TRUE)) %>%
  mutate(codmpio = stringr::str_pad(codmpio, 5, pad = "0"))

mun_sf_merged <- mun_sf %>%
  left_join(final_df_avg, by = c("MPIO_CDPMP" = "codmpio"))

head(mun_sf_merged)


library(ggplot2)

ggplot(mun_sf_merged) +
  geom_sf(aes(fill = gdp_pc), color = "black", size = 0.1) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(title = "GDP by Municipality (2022)", fill = "Population")


```


2022

```{r}

final_df_2022 <- final_df %>%
  filter(year == 2012) %>%
  mutate(codmpio = stringr::str_pad(codmpio, 5, pad = "0"))

mun_sf_merged <- mun_sf %>%
  left_join(final_df_avg, by = c("MPIO_CDPMP" = "codmpio"))

head(mun_sf_merged)


library(ggplot2)

ggplot(mun_sf_merged) +
  geom_sf(aes(fill = gdp_pc), color = "black", size = 0.1) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
  labs(title = "GDP by Municipality (2022)", fill = "Population")


```