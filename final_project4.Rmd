---
title: "Geospatial Final Project"
author: "Aranxa M√°rquez Ampudia & Milton Mier Santander"
date: "2025-05-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, include=FALSE}
library(sf) |> suppressMessages() 
library(dplyr) |> suppressMessages()
library(tidyr)
library(stringr)
library (terra) 
library(tmap) 
library(spdep) 
library(leaflet)
library(units) |> suppressMessages()
library(giscoR)
library(arrow)
library(jsonlite)
library(geojsonsf)
library(geojsonio)
library(spatialreg)
library(gridExtra)
library(sf)
sf_use_s2(FALSE)
```


## Load indicators data 

```{r}
# Load data
zip_filename <- "final_df.zip"
csv_filename <- "../final_df.csv"

# Temporary directory
temp_dir <- tempdir()

# Extract the specific CSV file to temp dir
unzip(zipfile = zip_filename, files = csv_filename, exdir = temp_dir)

# Extracted file will retain directory structure, verify exact path:
extracted_file_path <- file.path(temp_dir, csv_filename)

# Normalize path (since "../" could cause issues)
extracted_file_path <- normalizePath(extracted_file_path, mustWork = FALSE)

# Check if extraction succeeded:
if (!file.exists(extracted_file_path)) {
    stop("Extraction failed. Check filenames and paths.")
}

# Read the CSV into a dataframe
final_df <- read.csv(extracted_file_path)

# Clean up by deleting the file
file.remove(extracted_file_path)
```

```{r}
head(final_df)
```

## Load geospatial data 

```{r}
# Read GeoJSON
muni_sf <- geojson_sf("colombia_municipios_poblacion.json")
head(muni_sf)
```


```{r}
## Assigning manually the Coordinate Reference System (CRS)
st_crs(muni_sf) <- 4326

# Check number of geometries in original shapefile
nrow(muni_sf)

# Check number of records in final_df
nrow(final_df)

# Check join key overlap
length(intersect(muni_sf$MPIO_CDPMP, final_df$codmpio))
```


# Preprocessing

```{r}
# Convert both codes to character to ensure matching works
final_df <- final_df %>%
  mutate(codmpio = as.character(codmpio))

muni_sf <- muni_sf %>%
  mutate(MPIO_CCDGO = as.character(MPIO_CDPMP))
```


## Filter for 2022

```{r}
final_22 <- final_df %>%
  filter(year == 2022)
```


```{r}
muni_sf <- muni_sf %>%
  mutate(MPIO_CCDGO = str_pad(as.character(MPIO_CDPMP), width = 5, pad = "0"))

final_22 <- final_22 %>%
  mutate(codmpio = str_pad(as.character(codmpio), width = 5, pad = "0"))
```


## Join datasets

```{r}
joined_sf <- left_join(muni_sf, final_22, by = c("MPIO_CDPMP" = "codmpio"))
```


# Spatial Autocorrelation

## Handling missing values
```{r}
# drop all areas with NA values
joined_sf <- joined_sf |> filter(!is.na(iica))
```

## Mapping Conflict Incidence (iica)

We visualized the distribution of the conflict index (iica) across Colombian municipalities using a choropleth map. The color gradient represents normalized conflict intensity, ranging from low (dark purple) to high (yellow).

This map reveals clear spatial heterogeneity in conflict levels, with notable clusters of high intensity in the Pacific region, southern Colombia, and areas near the Venezuelan border. These visual patterns suggest the presence of spatial autocorrelation, which we test formally in the next section using Moran‚Äôs I statistic.


```{r}  
#S1: unemployment rate in percentage
qtm(joined_sf, fill="iica", fill.scale=tm_scale(values="viridis", n=10))
```

## Spatial Autocorrelation Test ‚Äî Moran‚Äôs I

To formally assess the presence of spatial autocorrelation in conflict incidence, we computed Moran‚Äôs I statistic using a spatial weights matrix (nbw) based on municipality contiguity. The test evaluates whether similar values of iica (conflict intensity) cluster together in space more than expected by chance.

Interpretation:
The Moran‚Äôs I value of 0.53 is strongly positive, indicating a high degree of spatial clustering in conflict levels.

The p-value < 2.2e-16 confirms this result is statistically significant ‚Äî we reject the null hypothesis of spatial randomness.

This justifies the use of spatial regression models in the next steps, as standard OLS would violate the independence assumption.

```{r}
# first we again define the neighbors
# in this case, we consider direct neighbors
nb <- poly2nb(joined_sf, queen = TRUE)

# the we create weights for the neighbors with style: row standardized
nbw <- nb2listw(nb, style = "W", zero.policy = T)

# we set our hypothesis to: alternative to "greater", which means we expect positive autocorrelation
gmoran <- moran.test(joined_sf$iica, nbw,
                     alternative = "greater")

gmoran
```
Moran‚Äôs I Scatterplot

To visualize the spatial autocorrelation in conflict incidence, we plotted a Moran scatterplot, which compares each municipality‚Äôs conflict value (iica) to the spatially lagged average of its neighbors.

This plot is divided into four quadrants:

Top right (High‚ÄìHigh): Municipalities with high conflict levels surrounded by others with high conflict.

Bottom left (Low‚ÄìLow): Municipalities with low conflict levels surrounded by others with low conflict.

Top left (Low‚ÄìHigh): Municipalities with low conflict values, but surrounded by high-conflict neighbors (potential outliers or transition zones).

Bottom right (High‚ÄìLow): Municipalities with high conflict values but low-conflict neighbors.

The upward-sloping red line confirms the positive spatial autocorrelation already identified through Moran‚Äôs I ‚Äî municipalities tend to resemble their neighbors in terms of conflict intensity.



```{r}
mp <- moran.plot(joined_sf$iica, nbw, labels=F)
mp
# spatially lagged values: mp$wx
```

## Local Indicators of Spatial Association (LISA)(Local Moran's I)

To explore where spatial autocorrelation occurs, we computed Local Moran‚Äôs I statistics. While the global Moran‚Äôs I indicates whether clustering exists overall, Local Moran‚Äôs I (LISA) identifies specific municipalities that exhibit significant local clustering of conflict levels.

```{r moransI-local}
lmoran <- localmoran(joined_sf$iica, nbw, alternative = "two.sided")
head(lmoran)
```

To explore where spatial autocorrelation occurs, we computed Local Moran‚Äôs I statistics. While the global Moran‚Äôs I indicates whether clustering exists overall, Local Moran‚Äôs I (LISA) identifies specific municipalities that exhibit significant local clustering of conflict levels.

We now display results for the two-sided test (H1: positive or negative spatial autocorrelation), only considering p values below 0.05 as significant.


Map 1: Local Moran‚Äôs I Statistic
- Areas in darker green show higher positive spatial autocorrelation (lmI_sign).
- Purple tones suggest negative local spatial association.
- Most significant clusters appear along the Pacific coast, northeast, and border regions.

Map 2: Classification of Significant Spatial Autocorrelation
- We classified municipalities with significant local Moran‚Äôs I into:
- Positive SAC (green): High values surrounded by high values or low by low.
- Negative SAC (purple): High values surrounded by low values or vice versa.

Interpretation:
- Positive spatial autocorrelation dominates, especially in conflict-heavy regions like the Pacific and northeast.
- This confirms that conflict incidence is not randomly distributed, but spatially clustered.
- These spatial patterns help justify the need for regional policy coordination and the use of spatial econometric models in the next section.

```{r moransI-local-map}
joined_sf$lmI <- lmoran[, "Ii"] # local Moran's I
# p-values corresponding to alternative greater
joined_sf$lmp <- lmoran[, "Pr(z != E(Ii))"]
joined_sf$lmI_sign <- joined_sf$lmI
#joined_sf[joined_sf$lmp >= 0.05, "lmI_sign"] <- NA

qtm(joined_sf, fill="lmI_sign")

tm_shape(joined_sf) + 
  tm_polygons(
  fill = "lmI_sign",
  fill.legend = tm_legend(title = "spatial autocorrelation"),
  fill.scale=tm_scale(
    breaks = c(min(joined_sf$lmI_sign, na.rm=T), 0, max(joined_sf$lmI_sign, na.rm=T)),
    labels = c("Negative SAC","Positive SAC"),
    textNA = "not significant")
  )
```


## Identifying Local Spatial Clusters
To better understand how conflict clusters spatially, we classified municipalities using Local Moran‚Äôs I quadrants. This typology helps distinguish between core hotspots, outliers, and areas of low conflict intensity.

Quadrant Categories:
üî¥ High‚ÄìHigh (Hotspots): Municipalities with high conflict, surrounded by high-conflict neighbors.
üîµ Low‚ÄìLow (Coldspots): Low-conflict municipalities surrounded by similarly low-conflict areas.
üü¶ Low‚ÄìHigh (Spatial Outliers): Low-conflict municipalities surrounded by high-conflict neighbors.
ü©∑ High‚ÄìLow (Spatial Outliers): High-conflict municipalities surrounded by low-conflict neighbors.
‚ö™ Non-significant: No statistically significant local autocorrelation (p ‚â• 0.05).

Identifying Clusters
Local Moran‚Äôs I allows us to identify clusters of the following types:

-   High-High: areas of high values with neighbors of high values,
-   High-Low: areas of high values with neighbors of low values,
-   Low-High: areas of low values with neighbors of high values,
-   Low-Low: areas of low values with neighbors of low values.

Map: Local Conflict Clusters by Moran's Quadrant
This map highlights regional conflict hotspots in:
- The Pacific coast, southwest, and northeast, dominated by High‚ÄìHigh clusters, indicating strong and persistent spatial patterns of violence.
- Some municipalities appear as spatial outliers (Low‚ÄìHigh or High‚ÄìLow), possibly signaling transitional or volatile zones.

```{r moransI-local-clusters}

# scale such that mean is 0
#mp <- moran.plot(as.vector(scale(la_income$estimate)), nbw)

# get quadrant information
joined_sf$quadr <- attributes(lmoran)$quadr$mean
levels(joined_sf$quadr) <- c(levels(joined_sf$quadr), "non-significant")
joined_sf[(joined_sf$lmp >= 0.05) & !is.na(joined_sf$lmp), "quadr"] <- "non-significant"
```

# Visualisations

## Significant quadrants:
```{r moransI-local-clusters-plot}
tm_shape(joined_sf) + 
  tm_polygons(
    fill = "quadr",
    fill.scale=tm_scale(values = c("blue", "lightpink", "skyblue2", "red", "white"))
)
```

## Distribution of the Outcome Variable

We first examined the distribution of the outcome variable, iica ‚Äî an index measuring armed conflict incidence at the municipal level in 2022.

As shown in the histogram, the distribution of iica is heavily right-skewed, with the vast majority of municipalities reporting very low conflict levels and a long tail of high values. This violates the normality assumption of linear models.

Log Transformation: To normalize the distribution and improve model fit, we applied a log transformation to iica:

The log-transformed outcome is much closer to a normal distribution, making it more suitable for regression analysis. This transformation also helps interpret model coefficients in terms of proportional effects on conflict intensity.

```{r outcome-variable}
hist(joined_sf$iica, nclass=50)
```

```{r outcome-variable-log}
hist(log(joined_sf$iica), nclass=50)
```


# Regression models

## Initial (Non-Spatial) Regression Model
We first estimated a baseline linear regression model to assess whether municipal-level socio-economic indicators predict conflict intensity (log(iica)).

- Significant predictors: coca cultivation, displacement, and GDP per capita.
- Model fit: R¬≤ = 0.13 (modest explanatory power).
- Assumptions: The residuals show patterns of spatial autocorrelation, indicating a violation of the independence assumption.


```{r regression-model}
# Filter rows without NAs (just in case)
joined_clean <- joined_sf %>%
  filter(!is.na(iica), iica > 0) %>%
  filter(!is.na(gdp_pc)) %>%
  filter(!is.na(H_coca)) %>%
  filter(!is.na(fisc_perf)) %>%
  filter(!is.na(e_desplaza))  

joined_clean2 <- joined_clean |>
  na.omit()

# this is our initial regression model 
formula <- formula(log(iica) ~ gdp_pc + H_coca + fisc_perf + e_desplaza)

model1 <- lm(formula = formula, data = joined_clean, na.action = na.omit)
summary(model1)
```


# Spatial Autocorrelation of Residuals
To assess whether spatial dependence remains in the residuals of the non-spatial regression model, we applied Moran‚Äôs I test.

Results:
Moran‚Äôs I = 0.367
p-value < 2.2e-16
Statistically significant positive spatial autocorrelation
This result confirms that the residuals are not randomly distributed in space, violating the assumption of independence and suggesting spatial spillover effects.

Residuals vs. Lagged Residuals Plot
The upward trend in this scatterplot supports the Moran‚Äôs I result, showing that municipalities with high (or low) residuals tend to be surrounded by neighbors with similar residuals.
Conclusion: A spatial regression model is needed to capture this remaining autocorrelation.

```{r autocorrelation}
# create list of neighbors
wts <- joined_clean |>
  poly2nb() |>
  nb2listw(style = "W", zero.policy = T)

# use Morans I test if there is still autocorrelation in our residuals
moran.test(model1$residuals, wts)
```
```{r residual-dist23}
library(ggplot2)
residuals_model1 <- residuals(model1)
lagged_residuals_model1 <- lag.listw(wts, residuals_model1)

res <- data.frame("lagged_residuals"=lagged_residuals_model1, "residuals"=residuals_model1)

ggplot(res, aes(x = residuals, y = lagged_residuals)) +
  theme_minimal() +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red")
```

## 1. Spatially Lagged X Model (SLX)
To account for potential spatial spillovers of the independent variables, we estimated an SLX model, which augments the standard OLS specification by including spatially lagged covariates.

Key Findings:
Variable	Coefficient	p-value	Significant?	Interpretation
H_coca	+0.0001355	0.0027	‚úÖ Yes	More coca cultivation in a municipality ‚Üí higher conflict.
lag.H_coca	+0.0002094	0.0027	‚úÖ Yes	Coca cultivation in neighboring municipalities also increases conflict.
e_desplaza	+0.0001514	1.34e-05	‚úÖ Yes	More forced displacement ‚Üí higher conflict.
lag.e_desplaza	+0.0004112	9.30e-10	‚úÖ Yes	Neighboring displacement also increases conflict.
gdp_pc & lag.gdp_pc	n.s.	> 0.1	‚ùå No	Economic performance not a significant predictor.
fisc_perf & lag.fisc_perf	n.s.	> 0.1	‚ùå No	Fiscal performance is not associated with conflict.

üìå Interpretation:
- Coca cultivation and displacement have both local and spatial spillover effects, indicating that conflict intensity is influenced not only by conditions within a municipality but also by those of its neighbors.
- Economic and fiscal indicators show no significant direct or spillover effects in this specification.

```{r slx}
vars_used <- all.vars(formula(model1))  # Includes dependent + independent variables
summary(joined_clean[, vars_used])      # Check for NAs, negative values, etc.

class(joined_clean)
# Should include "sf"

library(spatialreg)

formula <- formula(log(iica) ~ gdp_pc + H_coca + fisc_perf + e_desplaza)

# SLX model (includes spatial lags of X variables only)
slx_model <- lmSLX(formula, data = joined_clean, listw = wts, zero.policy = TRUE)
summary(slx_model)
```
Direct and Indirect Effects

To better interpret the coefficients of the SLX model, we compute impacts, which decompose the estimated effects into:
- Direct effects: The impact of a predictor on conflict within the same municipality.
- Indirect effects (spillovers): The effect of that predictor in neighboring municipalities.
- Total effect: Sum of direct + indirect.

Summary of Impacts
Variable	Direct Effect	Indirect Effect	Total Effect	Significant?
gdp_pc	-0.00097	-0.00046	-0.00143	‚ùå No
H_coca	+0.00014	+0.00021	+0.00035	‚úÖ Yes
fisc_perf	-0.00632	-0.00139	-0.00771	‚ùå No
e_desplaza	+0.00015	+0.00041	+0.00056	‚úÖ Yes

Interpretation
- Coca cultivation (H_coca) and forced displacement (e_desplaza) show statistically significant direct and spillover effects.
- This confirms that conflict intensity is influenced not only by internal municipal conditions but also by dynamics in neighboring areas.
- GDP per capita and fiscal performance show small and non-significant effects in both direct and indirect terms.

```{r slx-impact}
summary(impacts(slx_model))
```
To verify whether the SLX model sufficiently accounts for spatial dependence, we ran Moran's I test on its residuals.

Result:
Moran‚Äôs I statistic: 0.346
p-value: < 2.2e-16

Conclusion: Residuals still exhibit significant positive spatial autocorrelation.

Interpretation:
Despite including spatially lagged predictors, the SLX model fails to fully capture spatial dependence. This suggests the need for models that account for spatial dependence in the dependent variable or error term, such as the SAR (spatial lag) or SEM (spatial error) models.

```{r slx-autoregression}
moran.test(slx_model$residuals, wts)
```
## 2. Spatial Lag Model (SAR)
To address the limitations of the SLX model, we estimate a Spatial Lag Model (SAR) using Maximum Likelihood.





Key Findings:

Spatial dependence (Rho) is strong and highly significant:
œÅ = 0.576, p < 0.001 ‚Üí confirms that conflict levels in neighboring municipalities are positively correlated.
Significant predictors:
H_coca (Coca cultivation): positive effect, p < 0.001
e_desplaza (Forced displacement): positive effect, p < 0.001
gdp_pc and fisc_perf are not significant

Model fit improvements:
AIC reduced from 3574.7 (OLS) to 3289.6 (SAR)
Nagelkerke pseudo-R¬≤ = 0.356

Remaining issues:
LM test for residual autocorrelation still significant (p < 0.001) ‚Üí suggests some spatial structure remains in the residuals.

Interpretation:
This model captures spatial spillover in the dependent variable, indicating that conflict intensity is not only influenced by local conditions but also by those in adjacent municipalities. However, residual autocorrelation persists‚Äîmotivating exploration of a Spatial Error Model (SEM) next.


```{r slm}
# spatial lag models
lag_model <- lagsarlm(
  formula = formula,
  data = joined_clean,
  listw = wts, # taking the same weights as before
  zero.policy = T
  )
summary(lag_model, Nagelkerke = TRUE)
```

The spatial lag model includes both direct and indirect (spillover) effects of predictors on conflict intensity (log-transformed iica). The estimated spatial autoregressive coefficient (œÅ = 0.576, p < 0.001) indicates a strong and significant spatial dependence, justifying the model choice.

Direct effects reflect the impact within a municipality, while indirect effects capture spillover effects on neighboring municipalities. Total effects are the sum of both.

Interpretation
H_coca and e_desplaza have statistically significant total effects, indicating both local and spillover influences on conflict intensity.
gdp_pc and fisc_perf do not exhibit statistically significant effects under this model.
The spatial lag (œÅ) is strong and significant, validating the presence of spatial dependence in the outcome.

```{r slm-impacts}

imp <- impacts(lag_model, listw = wts, R=100) # compute impacts
imp
```

```{r slm-impacts2}
#To print the p values
summary(imp, zstats=T)$pzmat
```
Residual Autocorrelation Check
After estimating the spatial lag model, we tested the residuals for remaining spatial autocorrelation using Moran's I.

Result:
Moran's I: -0.0509
p-value: 0.993
Interpretation: Not statistically significant.

Conclusion: The absence of spatial autocorrelation in the residuals confirms that the spatial lag model effectively captures the underlying spatial dependence in the data.

```{r slm-morans}
moran.test(lag_model$residuals, wts)
```

## Spatial Error Model (SEM)
The SEM accounts for unobserved spatial processes by modeling spatial autocorrelation in the error term, rather than in the dependent variable directly.

Key Results
Lambda (spatial error coefficient): 0.621
‚Üí Highly significant (p < 2.2e-16), confirming the presence of spatial error dependence.
AIC: 3302.5
‚Üí Lower than OLS (3574.7) but slightly higher than spatial lag model (3289.6).
Pseudo-R¬≤: 0.347
‚Üí Indicates a better model fit than OLS (0.1335).

Variable Significance
Variable	Coefficient	p-value	Significant?
Intercept	-3.6646	< 0.001	‚úÖ Yes
gdp_pc	-0.00127	0.3593	‚ùå No
H_coca	0.000123	0.00145	‚úÖ Yes
fisc_perf	0.000301	0.9383	‚ùå No
e_desplaza	0.000097	0.0012	‚úÖ Yes

Interpretation:
The SEM improves model fit and confirms that displacement and coca cultivation are positively associated with higher conflict intensity. However, the slightly higher AIC compared to the spatial lag model suggests the lag model remains the best fit overall.

```{r sem}
error_model <- errorsarlm(
formula = formula,
data = joined_clean,
listw = wts,
zero.policy = TRUE
)
summary(error_model, Nagelkerke = TRUE)
```

To evaluate whether the spatial error model effectively captures spatial dependence, we assess spatial autocorrelation in its residuals using Moran‚Äôs I.

Results:
Moran‚Äôs I statistic: -0.055
p-value: 0.996
Interpretation: No significant spatial autocorrelation remains in the residuals.

Conclusion:
The SEM successfully removes residual spatial dependence, confirming it is a valid model specification that appropriately accounts for latent spatial processes.

```{r sem-morans}
moran.test(error_model$residuals, wts)
```


#### Model Comparison: Lagrange Multiplier (LM) Tests

To determine whether a spatial lag or spatial error model is more appropriate, we conducted LM tests on the OLS model residuals.

Results:
LM Error (Rao's score): 323.02, p-value < 2.2e-16
LM Lag (Rao's score): 380.10, p-value < 2.2e-16
Interpretation:
Both tests are highly significant, indicating the presence of spatial dependence. Since LM-Lag has a higher test statistic, the spatial lag model is slightly preferred over the error model in this case.

```{r lagrange}
lm.LMtests(
  model1,
  wts,
  test = c("LMerr", "LMlag")
  # LM error, LM lag
)
```

##Robust Lagrange Multiplier (LM) Tests

We ran robust versions of the LM tests to determine which spatial model is more appropriate when both LM-Lag and LM-Error are initially significant.

Results:
Robust LM Error: adjRSer = 0.058, p-value = 0.8099
Robust LM Lag: adjRSLag = 57.136, p-value = 4.06e-14

Interpretation:
Only the Robust LM Lag test is statistically significant. This confirms that the spatial lag model (SAR) is the most appropriate specification for capturing spatial dependence in our data.

```{r lagrange_robust}
lm.LMtests(
  model1,
  wts,
  test = c("RLMerr", "RLMlag")
  # robust LM error, robust LM lag
)
```
Model Comparison and Selection
To determine the most suitable model for capturing spatial dynamics in conflict intensity, we used multiple criteria:

1. Robust Lagrange Multiplier Tests
These tests help assess whether spatial dependence is best captured through a spatial lag (SAR) or a spatial error (SEM) specification.
Robust LM Lag: Significant (p < 0.001)
Robust LM Error: Not significant (p = 0.81)

Interpretation: Strong evidence favors the spatial lag model (SAR), as it captures spatial spillovers in the outcome variable.

2. Akaike Information Criterion (AIC)
Interpretation: Both spatial models drastically outperform the non-spatial OLS baseline.
The SAR model has the lowest AIC, indicating the best trade-off between fit and model complexity.

Final Decision:
Based on both the Robust LM tests and AIC, the spatial lag model (SAR) provides the best specification for modeling spatial dependence in municipal-level conflict intensity in Colombia.

```{r AIC}
AIC(model1, lag_model, error_model)
```
